## Caddy (Reverse Proxy)

Status: current
Last verified: 2025-10-08

← Back to [`docs/README.md`](../README.md)

### Why this exists

- Provide a single public entrypoint that terminates TLS, assigns a correlation id, and routes all traffic to the gateway.
- Keep internal services private on the bridge network to reduce attack surface.

### Role in the system

- Internet-facing reverse proxy in front of the gateway.
- Adds a unique `X-Request-ID` to each request and forwards it upstream for end‑to‑end correlation.
- Emits JSON access logs to stdout for collection by the logging agent.

### How it works

- Caddyfile config

  Source: [`caddy/Caddyfile`](../../caddy/Caddyfile)

  ```
  example.com {
      header X-Request-ID {http.request.uuid}
      reverse_proxy gateway:8080 {
          header_up X-Request-ID {http.request.uuid}
      }
      log {
          output stdout
          format json
      }
  }
  ```

- The `X-Request-ID` header is generated by Caddy and forwarded to the gateway. Go services read it via shared middleware and include it in structured logs.

  Source: [`shared/middleware/logging.go`](../../shared/middleware/logging.go)

  ```go
  // RequestIDMiddleware extracts the request ID from headers and adds it to the context
  func RequestIDMiddleware(next http.Handler) http.Handler {
      return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
          requestID := r.Header.Get("X-Request-ID")
          // ...
      })
  }
  ```

### Operations

- Ports: exposes `80` and `443` only; upstream gateway is on the private network.
- Logs: JSON access logs to stdout (collected by Datadog agent when enabled).
- Reload: update `caddy/Caddyfile` and restart/reload the container.

### Examples

- End‑to‑end correlation
  - Caddy sets and forwards `X-Request-ID`.
  - Gateway handlers read it via `RequestIDMiddleware` and log it using the shared logger.

### Future

- None at this time.

### See also

- Gateway overview: [`docs/gateway/README.md`](../gateway/README.md)
- Observability overview: [`docs/observability/README.md`](../observability/README.md)
- Deployment topology: [`docs/deploy/runtime-topology.md`](../deploy/runtime-topology.md)
