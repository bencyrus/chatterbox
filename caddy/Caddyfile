api.glovee.io {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Forward all API requests to gateway
    reverse_proxy gateway:8080 {
        header_up X-Request-ID {http.request.uuid}
    }

    log {
        output stdout
        format json
    }
}

docs.glovee.io {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Serve the OpenAPI spec at /openapi.json via the gateway
    handle /openapi.json {
        reverse_proxy gateway:8080 {
            header_up X-Request-ID {http.request.uuid}
        }
    }

    # All other paths serve Swagger UI (index + static assets)
    reverse_proxy swaggerui:8080 {
        header_up X-Request-ID {http.request.uuid}
    }

    log {
        output stdout
        format json
    }
}

glovee.io {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Apple App Site Association (AASA) for universal links
    @aasaWellKnown path /.well-known/apple-app-site-association
    handle @aasaWellKnown {
        header Content-Type application/json
        respond <<EOF
{
  "applinks": {
    "apps": [],
    "details": [{
      "appID": "{$AASA_APP_ID}",
      "paths": ["{$AASA_PATHS}"]
    }]
  }
}
EOF
    }

    @aasaRoot path /apple-app-site-association
    handle @aasaRoot {
        header Content-Type application/json
        respond <<EOF
{
  "applinks": {
    "apps": [],
    "details": [{
      "appID": "{$AASA_APP_ID}",
      "paths": ["{$AASA_PATHS}"]
    }]
  }
}
EOF
    }

    # Android Digital Asset Links for App Links verification
    @assetlinks path /.well-known/assetlinks.json
    handle @assetlinks {
        header Content-Type application/json
        respond <<EOF
[
  {
    "relation": ["delegate_permission/common.handle_all_urls"],
    "target": {
      "namespace": "android_app",
      "package_name": "{$ANDROID_APP_PACKAGE}",
      "sha256_cert_fingerprints": ["{$ANDROID_APP_SHA256_FPS}"]
    }
  }
]
EOF
    }

    # Default: 204 for other requests (no content)
    respond 204

    log {
        output stdout
        format json
    }
}
