api.glovee.io {
    log {
        output stdout
        format json
    }

    # Simple approach: intercept successful responses and add token headers
    reverse_proxy postgrest:3000 {
        @needs_refresh {
            status 2xx
            header X-Refresh-Token *
        }
        
        handle_response @needs_refresh {
            templates
            
            # Call refresh endpoint once and extract both tokens
            vars refresh_response "{{httpPost \"http://postgrest:3000/rpc/refresh_tokens\" (dict \"Content-Type\" \"application/json\" \"X-Refresh-Token\" (.Request.Header.Get \"X-Refresh-Token\"))}}"
            header X-New-Access-Token "{{$tokens := mustFromJson .Vars.refresh_response}}{{$tokens.access_token}}"
            header X-New-Refresh-Token "{{$tokens := mustFromJson .Vars.refresh_response}}{{$tokens.refresh_token}}"
            
            copy_response
        }
    }
}