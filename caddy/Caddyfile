api.chatterboxtalk.com {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Forward all API requests to gateway
    reverse_proxy gateway:8080 {
        header_up X-Request-ID {http.request.uuid}
        
        # Handle backend failures with proper error response
        @backend_down status 502 503 504
        handle_response @backend_down {
            header Content-Type application/json
            respond `{"error": "API service temporarily unavailable", "message": "The backend service is not responding. Please try again later.", "request_id": "{http.request.uuid}"}` 503
        }
    }

    log {
        output stdout
        format json
    }
}

docs.chatterboxtalk.com {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Serve the OpenAPI spec at /openapi.json via the gateway
    handle /openapi.json {
        reverse_proxy gateway:8080 {
            header_up X-Request-ID {http.request.uuid}
        }
    }

    # All other paths serve Swagger UI (index + static assets)
    reverse_proxy swaggerui:8080 {
        header_up X-Request-ID {http.request.uuid}
    }

    log {
        output stdout
        format json
    }
}

files.chatterboxtalk.com {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Proxy all requests to the files service
    reverse_proxy files:8080 {
        header_up X-Request-ID {http.request.uuid}
    }

    log {
        output stdout
        format json
    }
}

chatterboxtalk.com {
    # Add a unique UUID per request to the response headers
    header X-Request-ID {http.request.uuid}

    # Apple App Site Association (AASA) for universal links
    @aasaWellKnown path /.well-known/apple-app-site-association
    handle @aasaWellKnown {
        header Content-Type application/json
        respond <<EOF
{
  "applinks": {
    "apps": [],
    "details": [{
      "appID": "{$AASA_APP_ID}",
      "paths": ["{$AASA_PATHS}"]
    }]
  }
}
EOF
    }

    @aasaRoot path /apple-app-site-association
    handle @aasaRoot {
        header Content-Type application/json
        respond <<EOF
{
  "applinks": {
    "apps": [],
    "details": [{
      "appID": "{$AASA_APP_ID}",
      "paths": ["{$AASA_PATHS}"]
    }]
  }
}
EOF
    }

    # Android Digital Asset Links for App Links verification
    @assetlinks path /.well-known/assetlinks.json
    handle @assetlinks {
        header Content-Type application/json
        respond <<EOF
[
  {
    "relation": ["delegate_permission/common.handle_all_urls"],
    "target": {
      "namespace": "android_app",
      "package_name": "{$ANDROID_APP_PACKAGE}",
      "sha256_cert_fingerprints": ["{$ANDROID_APP_SHA256_FPS}"]
    }
  }
]
EOF
    }

    # Serve the marketing website
    reverse_proxy web:5173 {
        header_up X-Request-ID {http.request.uuid}
    }

    log {
        output stdout
        format json
    }
}
