api.glovee.io {
    log {
        output stdout
        format json
    }

    # For requests with refresh token, just call refresh function after success
    reverse_proxy postgrest:3000 {
        @needs_refresh {
            status 2xx
            header X-Refresh-Token *
        }
        
        handle_response @needs_refresh {
            # Simple: call refresh function and add any headers it sets
            templates
            header X-Token-Refresh-Result "{{httpPost "http://postgrest:3000/rpc/refresh_tokens" (dict "Content-Type" "application/json" "X-Refresh-Token" (.Request.Header.Get "X-Refresh-Token"))}}"
            copy_response
        }
    }
}